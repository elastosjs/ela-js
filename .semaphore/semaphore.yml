version: v1.0
name: Test MyApp
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Setup Local Ganache Blockchain
    task:
      jobs:
        - name: Install Blockchain
          commands:
            - sem-version node 10
            - cache restore
            - npm install ganache-cli
            - npm install @openzeppelin/cli
            - npm install @openzeppelin/gsn-helpers
            - cache store
            - nohup npx ganache-cli --gasLimit 8000000 --gasPrice 1000000000 > log.out 2>&1 &
            - sleep 10s
            - 'nohup npx oz-gsn run-relayer --ethereumNodeURL http://localhost:8545 --port 8091 > relay-log.out 2>&1 &'
            - 'grep -oP ''^Mnemonic:\s+\K(.*)$'' log.out'
            - npx oz init semaphore-test --no-interactive
            - sem get secret DateTimeSmartContract
            - ls
      secrets:
        - name: DateTimeSmartContract
      env_vars:
        - name: NODE_ENV
          value: semaphore
